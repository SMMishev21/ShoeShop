{% extends "base.html" %}
{% block content %}
<div class="admin-form-container">
    <h1>➕ Добави нова промоция</h1>
    
    <form method="post" class="admin-form">
        <div class="form-group">
            <label for="title">Заглавие на промоцията *</label>
            <input type="text" id="title" name="title" required 
                   placeholder="Например: Лятна разпродажба">
        </div>

        <div class="form-group">
            <label for="description">Описание</label>
            <textarea id="description" name="description" 
                      placeholder="Описание на промоцията, условия и т.н." 
                      rows="4"></textarea>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="start_date">Начална дата и час *</label>
                <input type="datetime-local" id="start_date" name="start_date" required>
            </div>

            <div class="form-group">
                <label for="end_date">Крайна дата и час *</label>
                <input type="datetime-local" id="end_date" name="end_date" required>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="discount_percent">Процент отстъпка *</label>
                <input type="number" id="discount_percent" name="discount_percent" 
                       min="1" max="100" step="1" required 
                       placeholder="Например: 20">
                <small>Въведете процент от 1 до 100</small>
            </div>

            <div class="form-group">
                <label for="promo_code">Промо код</label>
                <input type="text" id="promo_code" name="promo_code" 
                       placeholder="Например: SUMMER20" 
                       style="text-transform: uppercase;">
                <small>Оставете празно за автоматичен код</small>
            </div>
        </div>

        <div class="form-group">
            <label>Избери продукти за промоцията</label>
            <div class="products-grid">
                {% for product in products %}
                <div class="product-checkbox">
                    <input type="checkbox" id="product_{{ product.id }}" 
                           name="product_ids" value="{{ product.id }}">
                    <label for="product_{{ product.id }}">
                        <img src="{{ product.image_url }}" alt="{{ product.name }}" 
                             onerror="this.src='https://images.unsplash.com/photo-1460353581641-37baddab0fa2?auto=format&fit=crop&w=100&q=80'">
                        <div class="product-info">
                            <strong>{{ product.name }}</strong>
                            <span class="price">{{ product.price }} лв</span>
                        </div>
                    </label>
                </div>
                {% endfor %}
            </div>
            <small>Изберете продукти, които ще бъдат включени в промоцията. Ако не изберете нито един, промоцията ще се прилага за всички продукти.</small>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">✅ Създай промоция</button>
            <a href="{{ url_for('promotion.admin_promotions') }}" class="btn btn-secondary">❌ Откажи</a>
        </div>
    </form>
</div>

<style>
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
    max-height: 400px;
    overflow-y: auto;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
    border: 2px solid #e9ecef;
}

.product-checkbox {
    margin-bottom: 10px;
}

.product-checkbox input[type="checkbox"] {
    display: none;
}

.product-checkbox label {
    display: flex;
    align-items: center;
    padding: 12px;
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.product-checkbox input[type="checkbox"]:checked + label {
    border-color: #3498db;
    background: #e3f2fd;
}

.product-checkbox img {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 6px;
    margin-right: 12px;
}

.product-info {
    flex: 1;
}

.product-info strong {
    display: block;
    color: #2c3e50;
    font-size: 0.9rem;
    margin-bottom: 4px;
}

.product-info .price {
    color: #e74c3c;
    font-weight: bold;
    font-size: 0.9rem;
}

.form-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 2px solid #ecf0f1;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .products-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set minimum datetime to current time
    const now = new Date();
    const timezoneOffset = now.getTimezoneOffset() * 60000;
    const localISOTime = new Date(now - timezoneOffset).toISOString().slice(0, 16);
    
    document.getElementById('start_date').min = localISOTime;
    document.getElementById('end_date').min = localISOTime;

    // Auto-generate promo code if empty
    const promoCodeInput = document.getElementById('promo_code');
    promoCodeInput.addEventListener('blur', function() {
        if (!this.value.trim()) {
            const codes = ['SUMMER', 'WINTER', 'SPRING', 'AUTUMN', 'SALE', 'DISCOUNT', 'OFFER'];
            const randomCode = codes[Math.floor(Math.random() * codes.length)] + 
                             Math.floor(10 + Math.random() * 90);
            this.value = randomCode;
        }
    });

    // Validate end date is after start date
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    startDateInput.addEventListener('change', validateDates);
    endDateInput.addEventListener('change', validateDates);

    function validateDates() {
        const startDate = new Date(startDateInput.value);
        const endDate = new Date(endDateInput.value);
        
        if (startDate && endDate && startDate >= endDate) {
            alert('Крайната дата трябва да е след началната дата!');
            endDateInput.value = '';
        }
    }
});
</script>
{% endblock %}