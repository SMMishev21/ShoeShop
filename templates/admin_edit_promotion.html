{% extends "base.html" %}
{% block content %}
<div class="admin-form-container">
    <h1>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –ø—Ä–æ–º–æ—Ü–∏—è</h1>
    
    <form method="post" class="admin-form">
        <div class="form-group">
            <label for="title">–ó–∞–≥–ª–∞–≤–∏–µ –Ω–∞ –ø—Ä–æ–º–æ—Ü–∏—è—Ç–∞ *</label>
            <input type="text" id="title" name="title" value="{{ promotion.title }}" required>
        </div>

        <div class="form-group">
            <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea id="description" name="description" rows="4">{{ promotion.description }}</textarea>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="start_date">–ù–∞—á–∞–ª–Ω–∞ –¥–∞—Ç–∞ –∏ —á–∞—Å</label>
                <input type="datetime-local" id="start_date" name="start_date" 
                       value="{{ promotion.start_date.replace(' ', 'T') }}">
                <small>–¢–µ–∫—É—â–∞: {{ promotion.start_date }}</small>
            </div>

            <div class="form-group">
                <label for="end_date">–ö—Ä–∞–π–Ω–∞ –¥–∞—Ç–∞ –∏ —á–∞—Å</label>
                <input type="datetime-local" id="end_date" name="end_date" 
                       value="{{ promotion.end_date.replace(' ', 'T') }}">
                <small>–¢–µ–∫—É—â–∞: {{ promotion.end_date }}</small>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="discount_percent">–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç—Å—Ç—ä–ø–∫–∞ *</label>
                <input type="number" id="discount_percent" name="discount_percent" 
                       value="{{ promotion.discount_percent }}" min="1" max="100" step="1" required>
            </div>

            <div class="form-group">
                <label>–°—Ç–∞—Ç—É—Å</label>
                <div class="checkbox-group">
                    <input type="checkbox" id="is_active" name="is_active" 
                           {{ 'checked' if promotion.is_active }}>
                    <label for="is_active">–ê–∫—Ç–∏–≤–Ω–∞ –ø—Ä–æ–º–æ—Ü–∏—è</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>–ü—Ä–æ–º–æ –∫–æ–¥</label>
            <div class="promo-code-display">
                <code class="code-large">{{ promotion.promo_code }}</code>
                <small>–ü—Ä–æ–º–æ –∫–æ–¥—ä—Ç –Ω–µ –º–æ–∂–µ –¥–∞ —Å–µ –ø—Ä–æ–º–µ–Ω—è</small>
            </div>
        </div>

        <div class="form-group">
            <label>–ò–∑–±–µ—Ä–∏ –ø—Ä–æ–¥—É–∫—Ç–∏ –∑–∞ –ø—Ä–æ–º–æ—Ü–∏—è—Ç–∞</label>
            <div class="products-grid">
                {% for product in products %}
                <div class="product-checkbox">
                    <input type="checkbox" id="product_{{ product.id }}" 
                           name="product_ids" value="{{ product.id }}"
                           {{ 'checked' if product.id in promotion.products|map(attribute='id') }}>
                    <label for="product_{{ product.id }}">
                        <img src="{{ product.image_url }}" alt="{{ product.name }}" 
                             onerror="this.src='https://images.unsplash.com/photo-1460353581641-37baddab0fa2?auto=format&fit=crop&w=100&q=80'">
                        <div class="product-info">
                            <strong>{{ product.name }}</strong>
                            <span class="price">{{ product.price }} –ª–≤</span>
                        </div>
                    </label>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Promotion Preview -->
        <div class="preview-section">
            <h3>üîç –ü—Ä–µ–≥–ª–µ–¥ –Ω–∞ –ø—Ä–æ–º–æ—Ü–∏—è—Ç–∞</h3>
            <div class="promotion-preview">
                <div class="promotion-badge">-{{ promotion.discount_percent|round|int }}%</div>
                <h4>{{ promotion.title }}</h4>
                <p>{{ promotion.description or '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏–µ' }}</p>
                <div class="preview-dates">
                    <span>üìÖ –û—Ç: {{ promotion.start_date }}</span>
                    <span>üìÖ –î–æ: {{ promotion.end_date }}</span>
                </div>
                <div class="preview-products">
                    <strong>–ü—Ä–æ–¥—É–∫—Ç–∏ ({{ promotion.products|length }}):</strong>
                    {% for product in promotion.products[:3] %}
                    <span class="product-tag">{{ product.name }}</span>
                    {% endfor %}
                    {% if promotion.products|length > 3 %}
                    <span class="product-tag">... –∏ –æ—â–µ {{ promotion.products|length - 3 }}</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">üíæ –ó–∞–ø–∞–∑–∏ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ</button>
            <a href="{{ url_for('promotion.admin_promotions') }}" class="btn btn-secondary">‚ùå –û—Ç–∫–∞–∂–∏</a>
            <a href="{{ url_for('promotion.delete_promotion', promotion_id=promotion.id) }}" 
               class="btn-delete"
               onclick="return confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ –ø—Ä–æ–º–æ—Ü–∏—è—Ç–∞ \"{{ promotion.title }}\"?')">
               üóëÔ∏è –ò–∑—Ç—Ä–∏–π –ø—Ä–æ–º–æ—Ü–∏—è—Ç–∞
            </a>
        </div>
    </form>
</div>

<style>
.promo-code-display {
    text-align: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
    border: 2px dashed #dee2e6;
}

.code-large {
    background: #2c3e50;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    font-family: monospace;
    font-size: 1.3rem;
    display: inline-block;
    margin-bottom: 10px;
}

.checkbox-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 8px;
}

.checkbox-group input[type="checkbox"] {
    width: 18px;
    height: 18px;
}

.preview-section {
    margin: 30px 0;
    padding: 25px;
    background: #f8f9fa;
    border-radius: 12px;
    border-left: 4px solid #3498db;
}

.promotion-preview {
    background: white;
    padding: 20px;
    border-radius: 10px;
    position: relative;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.promotion-badge {
    position: absolute;
    top: 15px;
    right: 15px;
    background: #e74c3c;
    color: white;
    padding: 6px 12px;
    border-radius: 15px;
    font-weight: bold;
}

.preview-dates {
    margin: 15px 0;
}

.preview-dates span {
    display: block;
    color: #7f8c8d;
    margin-bottom: 5px;
}

.preview-products {
    margin-top: 15px;
}

.product-tag {
    display: inline-block;
    background: #ecf0f1;
    padding: 4px 8px;
    border-radius: 6px;
    margin: 2px;
    font-size: 0.8rem;
    color: #2c3e50;
}

.btn-delete {
    background: #e74c3c;
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    text-decoration: none;
    cursor: pointer;
    transition: background 0.3s;
}

.btn-delete:hover {
    background: #c0392b;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Date validation
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    startDateInput.addEventListener('change', validateDates);
    endDateInput.addEventListener('change', validateDates);

    function validateDates() {
        const startDate = new Date(startDateInput.value);
        const endDate = new Date(endDateInput.value);
        
        if (startDate && endDate && startDate >= endDate) {
            alert('–ö—Ä–∞–π–Ω–∞—Ç–∞ –¥–∞—Ç–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ —Å–ª–µ–¥ –Ω–∞—á–∞–ª–Ω–∞—Ç–∞ –¥–∞—Ç–∞!');
            endDateInput.value = '';
        }
    }

    // Real-time preview update
    const titleInput = document.getElementById('title');
    const descInput = document.getElementById('description');
    const discountInput = document.getElementById('discount_percent');

    function updatePreview() {
        document.querySelector('.promotion-preview h4').textContent = titleInput.value || '{{ promotion.title }}';
        document.querySelector('.promotion-preview p').textContent = descInput.value || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏–µ';
        document.querySelector('.promotion-badge').textContent = `-${discountInput.value || {{ promotion.discount_percent }}|round|int}%`;
    }

    titleInput.addEventListener('input', updatePreview);
    descInput.addEventListener('input', updatePreview);
    discountInput.addEventListener('input', updatePreview);
});
</script>
{% endblock %}